<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AltınTakip — PWA</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #0b1220; --bg-soft: #111827; --card: #0f172a; --text: #e5e7eb; --muted: #9ca3af;
      --gold: #fbbf24; --green: #10b981; --red: #ef4444; --border: #1f2937;
    }
    [data-theme="light"] {
      --bg: #f8fafc; --bg-soft: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #475569;
      --gold: #f59e0b; --green: #059669; --red: #dc2626; --border: #e5e7eb;
    }
    * { box-sizing: border-box } html, body { height: 100% }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    a { color: var(--gold); text-decoration: none }
    header { position: sticky; top: 0; z-index: 10; backdrop-filter: saturate(180%) blur(8px);
      background: color-mix(in srgb, var(--bg) 85%, transparent); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px }
    @media (min-width: 900px) { .row-2 { grid-template-columns: 1fr 1fr } .row-3 { grid-template-columns: 1fr 1fr 1fr } }
    .logo { display:flex; gap:10px; align-items:center; font-weight: 700; }
    .badge { font-size:12px; color: var(--muted); border:1px solid var(--border); padding:2px 8px; border-radius:999px }
    .btn { background: var(--gold); color: #111827; border: 0; padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    .btn.secondary { background: var(--bg-soft); color: var(--text); border: 1px solid var(--border) }
    .btn.ghost { background: transparent; color: var(--text); border: 1px solid var(--border) }
    .btn.danger { background: var(--red); color: #fff }
    .btn.small { padding: 6px 10px; border-radius: 8px; font-weight: 600; font-size: 12px }
    .grid { display: grid; gap: 12px }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .card h3 { margin: 0 0 10px 0; font-size: 16px }
    .headline { font-size: 22px; font-weight: 700; margin: 6px 0 10px }
    .muted { color: var(--muted) } .big { font-size: 24px; font-weight: 700 } .num { font-variant-numeric: tabular-nums }
    .field { display: grid; gap: 6px } .field label { font-size: 12px; color: var(--muted) }
    .input, select, input[type="datetime-local"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--bg-soft); color: var(--text); outline: none; }
    .split { display: grid; grid-template-columns: 1fr auto 100px; gap: 6px; align-items: center; }
    .split .sep { color: var(--muted); font-weight: 700 }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; background: var(--bg-soft); border: 1px solid var(--border); border-radius: 999px; font-size: 12px }
    .flex { display:flex; align-items:center; gap: 8px }
    .space { height: 16px } .divider { height: 1px; background: var(--border); margin: 10px 0 }
    .table { width: 100%; border-collapse: collapse } .table th, .table td { border-bottom: 1px solid var(--border); padding: 8px; text-align: left; font-size: 14px }
    .tag { padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 700 }
    .tag.buy { background: color-mix(in srgb, var(--green) 20%, transparent); color: var(--green); border: 1px solid color-mix(in srgb, var(--green) 40%, transparent) }
    .tag.sell { background: color-mix(in srgb, var(--red) 20%, transparent); color: var(--red); border: 1px solid color-mix(in srgb, var(--red) 40%, transparent) }
    .ok { color: var(--green) } .bad { color: var(--red) }
    .advice { display:grid; gap:8px } .advice .item { padding: 10px 12px; border-radius: 12px; border:1px solid var(--border); background: var(--bg-soft); }
    canvas { width: 100%; height: 130px; display:block }
    footer { text-align:center; color: var(--muted); padding: 32px 0 }
  </style>
</head>
<body>
  <header>
    <div class="wrap flex" style="justify-content: space-between;">
      <div class="logo">
        <span style="display:inline-flex;width:28px;height:28px;border-radius:8px;background:var(--gold);align-items:center;justify-content:center;color:#111827;font-weight:800">G</span>
        AltınTakip
        <span class="badge">PWA</span>
      </div>
      <div class="flex">
        <button id="quick-buy" class="btn small">Alış</button>
        <button id="quick-sell" class="btn small secondary">Satış</button>
        <button id="themeBtn" class="btn small ghost" title="Tema">Tema</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="gap:16px">
    <!-- Dashboard -->
    <section class="grid row-2">
      <div class="card">
        <div class="headline">Özet</div>
        <div class="grid row-3">
          <div>
            <div class="muted">Piyasa (tahmini)</div>
            <div class="big num" id="currentMarket">—</div>
            <div class="muted" style="font-size:12px">Spread <span class="num" id="spreadPct">7%</span></div>
          </div>
          <div>
            <div class="muted">Banka Alış</div>
            <div class="big num" id="bankBuy">—</div>
          </div>
          <div>
            <div class="muted">Banka Satış</div>
            <div class="big num" id="bankSell">—</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="grid row-3">
          <div>
            <div class="muted">Toplam Altın (g)</div>
            <div class="big num" id="holdings">0</div>
          </div>
          <div>
            <div class="muted">Portföy Değeri</div>
            <div class="big num" id="portfolioValue">—</div>
          </div>
          <div>
            <div class="muted">Ort. Maliyet (TL/g)</div>
            <div class="big num" id="avgCost">—</div>
          </div>
        </div>
        <div class="grid row-2" style="margin-top:10px">
          <div class="pill num">Net K/Z: <span id="netPnL" class="num">—</span> <span id="unrealizedPct" class="num muted"></span></div>
          <div class="pill num">Başabaş (Banka Satış): <span id="breakEvenBankSell">—</span></div>
        </div>
        <div class="space"></div>
        <div class="grid row-2">
          <div>
            <div class="field">
              <label>Banka Fiyatları (TL/g) — manuel gir</label>
              <div class="grid row-2">
                <div>
                  <div class="muted" style="font-size:12px;margin-bottom:4px">ALIŞ</div>
                  <div class="split">
                    <input id="bankBuyInt" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="tam">
                    <span class="sep">.</span>
                    <input id="bankBuyFrac" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="küsürat (2)">
                  </div>
                </div>
                <div>
                    <div class="muted" style="font-size:12px;margin-bottom:4px">SATIŞ</div>
                    <div class="split">
                      <input id="bankSellInt" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="tam">
                      <span class="sep">.</span>
                      <input id="bankSellFrac" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="küsürat (2)">
                    </div>
                </div>
              </div>
              <div class="flex" style="margin-top:8px">
                <button id="savePriceBtn" class="btn">Güncelle</button>
                <div class="muted" style="font-size:12px">En az biri doluysa kaydedilir. Piyasa değeri tahmini hesaplanır.</div>
              </div>
            </div>
          </div>
          <div class="grid">
            <div class="muted" style="font-size:12px">Hesaplar mevcut “banka satış” fiyatına göre yapılır.</div>
            <div class="flex">
              <span class="pill">Toplam Harcama: <b class="num" id="totalSpent">—</b></span>
              <span class="pill">Geri Dönüş: <b class="num" id="totalReturned">—</b></span>
            </div>
          </div>
        </div>

        <div class="space"></div>
        <div class="grid row-2">
          <div class="card">
            <h3>Fiyat Grafiği (Banka Satış)</h3>
            <canvas id="priceCanvas" width="600" height="150"></canvas>
          </div>
          <div class="card">
            <h3>Portföy Değeri</h3>
            <canvas id="valueCanvas" width="600" height="150"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="headline">Öneriler</div>
        <div class="advice" id="adviceList"></div>
        <div class="divider"></div>
        <div class="muted" style="font-size:12px">Basit kurallar; yatırım tavsiyesi değildir.</div>
      </div>
    </section>

    <!-- Transactions -->
    <section class="grid row-2">
      <div class="card">
        <div class="headline">İşlem Ekle</div>
        <form id="txForm" class="grid" style="gap:10px">
          <div class="flex">
            <button type="button" id="typeBuy" class="btn small">Alış</button>
            <button type="button" id="typeSell" class="btn small secondary">Satış</button>
            <span class="muted" id="typeLabel">Seçili: Alış</span>
            <button id="fillUnitBtn" class="btn small ghost" type="button">Şu anki fiyatı doldur</button>
          </div>
          <div class="row-2 grid">
            <div class="field">
              <label>Tarih/Saat</label>
              <input type="datetime-local" id="dateInput" />
            </div>
            <div class="field">
              <label>Gram (g)</label>
              <div class="split">
                <input id="gramsInt" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="tam">
                <span class="sep">.</span>
                <input id="gramsFrac" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="küsürat (3)">
              </div>
            </div>
          </div>
          <div class="row-2 grid">
            <div class="field">
              <label>Birim Fiyat (TL/g) — Alışta bankanın ALIŞ, satışta bankanın SATIŞ</label>
              <div class="split">
                <input id="unitInt" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="tam">
                <span class="sep">.</span>
                <input id="unitFrac" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="küsürat (2)">
              </div>
            </div>
            <div class="field">
              <label>Not (opsiyonel)</label>
              <input id="noteInput" class="input" placeholder="Örn: Ziraat mobil" />
            </div>
          </div>
          <div class="flex" style="justify-content: space-between;">
            <div class="muted" style="font-size:12px">Satış eklerken, eldeki gramı aşamazsın (tarihine göre kontrol).</div>
            <button class="btn" type="submit">Kaydet</button>
          </div>
        </form>
      </div>

      <div class="card">
        <div class="headline">İşlemler</div>
        <table class="table" id="txTable">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Tür</th>
              <th class="num">Gram</th>
              <th class="num">Birim (TL/g)</th>
              <th class="num">Tutar (TL)</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="txTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Settings -->
    <section class="grid row-2">
      <div class="card">
        <div class="headline">Ayarlar</div>
        <div class="row-2 grid">
          <div class="field">
            <label>Spread (%) — sadece tahmini piyasa ve başabaş piyasa için</label>
            <div class="split">
              <input id="spreadInt" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="tam">
              <span class="sep">.</span>
              <input id="spreadFrac" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="küsürat (2)">
            </div>
          </div>
          <div class="field">
            <label>Tema</label>
            <select id="themeSelect" class="input">
              <option value="system">Sistem</option>
              <option value="light">Açık</option>
              <option value="dark">Koyu</option>
            </select>
          </div>
        </div>
        <div class="space"></div>
        <div class="flex">
          <button id="exportBtn" class="btn ghost">Dışa Aktar (JSON)</button>
          <label class="btn ghost" for="importFile">İçe Aktar</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button id="clearBtn" class="btn danger">Tüm Veriyi Sil</button>
        </div>
      </div>
      <div class="card">
        <div class="headline">Bilgi</div>
        <div class="grid">
          <div class="muted">• PWA — ana ekrana ekle, offline çalışır.</div>
          <div class="muted">• Verilerin cihazında (localStorage).</div>
          <div class="muted">• Bu bir yatırım tavsiyesi değildir.</div>
        </div>
      </div>
    </section>
  </main>

  <footer>© <span id="year"></span> AltınTakip</footer>

  <script>
    // ---------- Utils
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const parseDigits = s => (s ?? '').replace(/\D/g,'');
    const fmtTL = n => (n == null || isNaN(n)) ? '—' : n.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 2 });
    const fmtNum = n => (n == null || isNaN(n)) ? '—' : n.toLocaleString('tr-TR', { maximumFractionDigits: 4 });
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const dtLocalValue = (d=new Date()) => {
      const pad = x => String(x).padStart(2,'0');
      const yy = d.getFullYear(), mm = pad(d.getMonth()+1), dd = pad(d.getDate());
      const hh = pad(d.getHours()), mi = pad(d.getMinutes());
      return `${yy}-${mm}-${dd}T${hh}:${mi}`;
    };

    // split helpers
    function setupSplit(prefix, decimals) {
      const i = qs('#'+prefix+'Int'), f = qs('#'+prefix+'Frac');
      const onInput = () => {
        i.value = parseDigits(i.value);
        f.value = parseDigits(f.value).slice(0, decimals);
      };
      i.addEventListener('input', onInput);
      f.addEventListener('input', onInput);
      onInput();
    }
    function hasSplit(prefix) {
      const i = qs('#'+prefix+'Int')?.value, f = qs('#'+prefix+'Frac')?.value;
      return parseDigits(i).length > 0 || parseDigits(f).length > 0;
    }
    function getSplit(prefix, decimals) {
      const i = parseDigits(qs('#'+prefix+'Int')?.value);
      const f = parseDigits(qs('#'+prefix+'Frac')?.value).slice(0, decimals);
      const iv = i ? parseInt(i,10) : 0;
      const fv = f ? parseInt(f,10) : 0;
      return iv + fv / Math.pow(10, decimals);
    }
    function setSplit(prefix, value, decimals) {
      const v = Number(value);
      if (!(v >= 0)) { qs('#'+prefix+'Int').value = ''; qs('#'+prefix+'Frac').value = ''; return; }
      const iv = Math.floor(v);
      let fv = Math.round((v - iv) * Math.pow(10, decimals));
      if (fv === Math.pow(10, decimals)) { // handle 1.999 -> 2.00
        qs('#'+prefix+'Int').value = String(iv + 1);
        qs('#'+prefix+'Frac').value = ''.padStart(decimals, '0');
      } else {
        qs('#'+prefix+'Int').value = String(iv);
        qs('#'+prefix+'Frac').value = String(fv).padStart(decimals, '0');
      }
    }

    // ---------- Storage
    const LS_KEYS = { tx: 'altintakip_transactions', prices: 'altintakip_prices', settings: 'altintakip_settings' };
    const load = (k, def) => { try { return JSON.parse(localStorage.getItem(k)) ?? def } catch(e){ return def } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let transactions = load(LS_KEYS.tx, []);
    // prices item: {id, date, bankBuy?, bankSell?, marketPrice?}
    let prices = load(LS_KEYS.prices, []);
    let settings = load(LS_KEYS.settings, { spread: 0.07, theme: 'system' });

    // ---------- Theme
    function applyTheme() {
      let t = settings.theme;
      if (t === 'system') t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
    }
    applyTheme();

    // ---------- Finance
    function sortByDateAsc(a,b){ return new Date(a.date) - new Date(b.date) || (a.id||'').localeCompare(b.id||'') }
    function sortByDateDesc(a,b){ return new Date(b.date) - new Date(a.date) || (b.id||'').localeCompare(a.id||'') }

    function recomputePortfolio(txns) {
      const tx = [...txns].sort(sortByDateAsc);
      let holdings = 0, avgCost = 0, realized = 0, totalSpent = 0, totalReturned = 0;
      for (const t of tx) {
        if (t.type === 'buy') {
          const costTotal = avgCost * holdings + t.unitPriceBank * t.grams;
          holdings += t.grams;
          avgCost = holdings > 0 ? costTotal / holdings : 0;
          totalSpent += t.unitPriceBank * t.grams;
        } else {
          const sellG = Math.min(t.grams, holdings);
          realized += (t.unitPriceBank - avgCost) * sellG;
          holdings -= sellG;
          totalReturned += t.unitPriceBank * sellG;
        }
      }
      return { holdings, avgCost, realizedPnL: realized, totalSpent, totalReturned };
    }

    function holdingsAt(dateISO, txns) {
      const tx = [...txns].filter(t => new Date(t.date) <= new Date(dateISO)).sort(sortByDateAsc);
      let h = 0; for (const t of tx) h += t.type === 'buy' ? t.grams : -t.grams;
      return h;
    }

    function latestPrices(spread) {
      const arr = [...prices].sort(sortByDateAsc);
      let bb = null, bs = null, mk = null;
      for (const p of arr) {
        if (p.bankBuy != null) bb = p.bankBuy;
        if (p.bankSell != null) bs = p.bankSell;
        if (p.marketPrice != null) mk = p.marketPrice;
      }
      let market = mk;
      if (market == null && bb != null) market = bb / (1 + spread);
      if (market == null && bs != null) market = bs / (1 - spread);
      if (bb == null && market != null) bb = market * (1 + spread);
      if (bs == null && market != null) bs = market * (1 - spread);
      return { bankBuy: bb, bankSell: bs, market };
    }

    function computeAll() {
      const { holdings, avgCost, realizedPnL, totalSpent, totalReturned } = recomputePortfolio(transactions);
      const spread = settings.spread ?? 0.07;
      const { bankBuy, bankSell, market: currentMarket } = latestPrices(spread);

      const portfolioValue = (bankSell != null) ? holdings * bankSell : null;
      const unrealizedPnL = (bankSell != null) ? (bankSell - avgCost) * holdings : null;
      const netPnL = (unrealizedPnL != null) ? (realizedPnL + unrealizedPnL) : realizedPnL;
      const unrealizedPct = (bankSell != null && avgCost > 0 && holdings > 0) ? ((bankSell - avgCost) / avgCost) * 100 : null;
      const breakEvenBankSell = avgCost > 0 ? avgCost : null;

      // Series
      const events = [
        ...transactions.map(t => ({ kind:'tx', ...t })),
        ...prices.map(p => ({ kind:'price', ...p }))
      ].sort((a,b) => new Date(a.date) - new Date(b.date) || (a.kind === 'tx' ? -1 : 1));

      let h=0, ac=0;
      const priceSeries = [], valueSeries = [];
      for (const ev of events) {
        if (ev.kind === 'tx') {
          if (ev.type === 'buy') {
            const tot = ac * h + ev.unitPriceBank * ev.grams;
            h += ev.grams; ac = h>0 ? tot/h : 0;
          } else {
            const g = Math.min(ev.grams, h); h -= g;
          }
        } else {
          // tercih: bankSell varsa onu çiz, yoksa bankBuy, o da yoksa market
          const ps = (ev.bankSell != null) ? ev.bankSell : (ev.bankBuy != null ? ev.bankBuy : (ev.marketPrice != null ? ev.marketPrice : null));
          if (ps != null) {
            priceSeries.push({ x: new Date(ev.date), y: ps });
            // değerleme için bankanın satışını tercih et
            const useSell = (ev.bankSell != null) ? ev.bankSell : (ev.marketPrice != null ? ev.marketPrice * (1 - spread) : (ev.bankBuy != null ? ev.bankBuy : null));
            if (useSell != null) valueSeries.push({ x: new Date(ev.date), y: h * useSell });
          }
        }
      }

      return {
        holdings, avgCost, realizedPnL, totalSpent, totalReturned,
        currentMarket, bankBuy, bankSell,
        portfolioValue, unrealizedPnL, netPnL, unrealizedPct, breakEvenBankSell,
        series: { priceSeries, valueSeries }
      };
    }

    function buildAdvice(state) {
      const tips = [];
      const { holdings, avgCost, bankSell } = state;
      if (bankSell == null) { tips.push('Banka satış girilmedi. Üstten fiyat güncelle.'); return tips; }
      if (holdings <= 0) { tips.push('Pozisyonun yok. Uygun gördüğünde alış ekleyebilirsin.'); return tips; }
      const gainPct = avgCost>0 ? (bankSell - avgCost) / avgCost : 0;
      if (gainPct >= 0.03) tips.push('Kâr %3 üzeri — satmayı düşünebilirsin.');
      else if (gainPct <= -0.03) tips.push('Maliyetinin altında — beklemek mantıklı olabilir.');
      tips.push(`Başabaş (Banka Satış): ${fmtTL(avgCost)} TL/g`);
      // %10 düşüş senaryosu (banka satış)
      const futureSell = bankSell * 0.9;
      const futureValue = holdings * futureSell;
      tips.push(`%10 düşüşte portföy değeri: ${fmtTL(futureValue)}`);
      return tips;
    }

    // ---------- Render
    function setText(id, txt, cls) {
      const el = qs('#'+id); if (!el) return;
      el.textContent = txt;
      if (cls) { el.classList.remove('ok','bad'); el.classList.add(cls); }
    }
    function drawSpark(canvas, data, color) {
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      if (!data || data.length < 2) {
        ctx.fillStyle = '#8884'; ctx.fillText('Yeterli veri yok', 10, 18); return;
      }
      const xs = data.map(p=>p.x.getTime()), ys = data.map(p=>p.y);
      const minX = Math.min(...xs), maxX = Math.max(...xs);
      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const pad = 8;
      const xScale = t => pad + (w-2*pad) * ( (t-minX) / (maxX-minX || 1) );
      const yScale = v => h-pad - (h-2*pad) * ( (v-minY) / (maxY-minY || 1) );
      ctx.lineWidth = 2;
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0, color); grad.addColorStop(1, color + '88');
      ctx.strokeStyle = color; ctx.beginPath();
      data.forEach((p,i)=>{ const x=xScale(p.x.getTime()), y=yScale(p.y); if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
      ctx.lineTo(xScale(xs.at(-1)), h-pad); ctx.lineTo(xScale(xs[0]), h-pad); ctx.closePath();
      ctx.fillStyle = grad; ctx.globalAlpha = 0.12; ctx.fill(); ctx.globalAlpha = 1;
      ctx.strokeStyle = '#ffffff22'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(pad, yScale(ys.at(-1))); ctx.lineTo(w-pad, yScale(ys.at(-1))); ctx.stroke();
    }

    function render() {
      save(LS_KEYS.tx, transactions);
      save(LS_KEYS.prices, prices);
      save(LS_KEYS.settings, settings);

      // spread split set
      setText('spreadPct', `${Math.round((settings.spread ?? 0.07)*100)}%`);
      setSplit('spread', (settings.spread ?? 0.07)*100, 2);

      const state = computeAll();
      const {
        holdings, avgCost, realizedPnL, totalSpent, totalReturned,
        currentMarket, bankBuy, bankSell,
        portfolioValue, netPnL, unrealizedPct, breakEvenBankSell,
        series
      } = state;

      setText('currentMarket', currentMarket!=null ? fmtTL(currentMarket) : '—');
      setText('bankBuy', bankBuy!=null ? fmtTL(bankBuy) : '—');
      setText('bankSell', bankSell!=null ? fmtTL(bankSell) : '—');

      setText('holdings', fmtNum(holdings));
      setText('portfolioValue', portfolioValue!=null ? fmtTL(portfolioValue) : '—');
      setText('avgCost', avgCost>0 ? fmtTL(avgCost) : '—');

      const pnlCls = netPnL>0 ? 'ok' : (netPnL<0 ? 'bad' : undefined);
      setText('netPnL', netPnL!=null ? fmtTL(netPnL) : '—', pnlCls);
      setText('unrealizedPct', unrealizedPct!=null ? `(${unrealizedPct.toFixed(2)}%)` : '');
      setText('breakEvenBankSell', breakEvenBankSell!=null ? fmtTL(breakEvenBankSell) : '—');

      setText('totalSpent', fmtTL(totalSpent));
      setText('totalReturned', fmtTL(totalReturned));

      // table
      const tbody = qs('#txTbody'); tbody.innerHTML = '';
      const rows = [...transactions].sort(sortByDateDesc);
      for (const t of rows) {
        const tr = document.createElement('tr');
        const dateStr = new Date(t.date).toLocaleString('tr-TR');
        tr.innerHTML = `
          <td>${dateStr}</td>
          <td><span class="tag ${t.type}">${t.type==='buy'?'Alış':'Satış'}</span></td>
          <td class="num">${fmtNum(t.grams)}</td>
          <td class="num">${fmtTL(t.unitPriceBank)}</td>
          <td class="num">${fmtTL(t.unitPriceBank * t.grams)}</td>
          <td class="num"><button class="btn small ghost" data-del="${t.id}">Sil</button></td>
        `;
        tbody.appendChild(tr);
      }
      qsa('[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          transactions = transactions.filter(t => t.id !== id);
          render();
        });
      });

      // advice
      const adv = qs('#adviceList'); adv.innerHTML = '';
      for (const t of buildAdvice(state)) {
        const div = document.createElement('div'); div.className = 'item'; div.textContent = '• ' + t; adv.appendChild(div);
      }

      // charts
      drawSpark(qs('#priceCanvas'), series.priceSeries, getComputedStyle(document.body).getPropertyValue('--gold').trim());
      drawSpark(qs('#valueCanvas'), series.valueSeries, getComputedStyle(document.body).getPropertyValue('--green').trim());
    }

    // ---------- Events
    // split setups
    setupSplit('bankBuy', 2);
    setupSplit('bankSell', 2);
    setupSplit('grams', 3);
    setupSplit('unit', 2);
    setupSplit('spread', 2);

    // price update: save manual bank buy/sell
    qs('#savePriceBtn').addEventListener('click', () => {
      const hasBB = hasSplit('bankBuy');
      const hasBS = hasSplit('bankSell');
      if (!hasBB && !hasBS) { alert('En az ALIŞ veya SATIŞ değeri giriniz'); return; }
      const p = { id: uid(), date: new Date().toISOString() };
      if (hasBB) p.bankBuy = getSplit('bankBuy', 2);
      if (hasBS) p.bankSell = getSplit('bankSell', 2);
      prices.push(p);
      // clear inputs
      setSplit('bankBuy', NaN, 2);
      setSplit('bankSell', NaN, 2);
      render();
    });

    // quick action + type toggle
    let currentType = 'buy';
    function setType(t) {
      currentType = t;
      qs('#typeLabel').textContent = 'Seçili: ' + (t==='buy'?'Alış':'Satış');
      qs('#typeBuy').className = 'btn small' + (t==='buy'?'':' secondary');
      qs('#typeSell').className = 'btn small' + (t==='sell'?'':' secondary');
    }
    qs('#typeBuy').addEventListener('click', ()=>setType('buy'));
    qs('#typeSell').addEventListener('click', ()=>setType('sell'));
    qs('#quick-buy').addEventListener('click', ()=>{ setType('buy'); window.scrollTo({ top: document.body.scrollHeight/3, behavior:'smooth' }); });
    qs('#quick-sell').addEventListener('click', ()=>{ setType('sell'); window.scrollTo({ top: document.body.scrollHeight/3, behavior:'smooth' }); });

    // fill current unit price from latest bank buy/sell
    qs('#fillUnitBtn').addEventListener('click', () => {
      const { bankBuy, bankSell } = latestPrices(settings.spread ?? 0.07);
      const v = currentType==='buy' ? bankBuy : bankSell;
      if (v == null) { alert('Önce üstten ilgili banka fiyatını gir.'); return; }
      setSplit('unit', v, 2);
    });

    // tx form defaults
    qs('#dateInput').value = dtLocalValue(new Date());
    setType('buy');

    // tx submit
    qs('#txForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const date = qs('#dateInput').value ? new Date(qs('#dateInput').value) : new Date();
      const grams = getSplit('grams', 3);
      const unitPrice = getSplit('unit', 2);
      const note = qs('#noteInput').value?.trim() || undefined;

      if (!(grams > 0)) return alert('Geçerli gram giriniz');
      if (!(unitPrice > 0)) return alert('Geçerli birim fiyat giriniz');

      // satış validasyon - tarihe kadar eldeki gram
      if (currentType === 'sell') {
        const h = holdingsAt(date.toISOString(), transactions);
        if (grams > h) return alert(`Eldeki gram (${fmtNum(h)}) üstünde satış yapılamaz`);
      }

      const tx = {
        id: uid(),
        date: date.toISOString(),
        type: currentType,
        grams,
        unitPriceBank: unitPrice, // alış: bankanın alış, satış: bankanın satış
        note
      };
      transactions.push(tx);

      // reset
      setSplit('grams', NaN, 3);
      setSplit('unit', NaN, 2);
      qs('#noteInput').value = '';
      qs('#dateInput').value = dtLocalValue(new Date());
      render();
    });

    // settings: spread split
    const themeSelect = qs('#themeSelect');
    themeSelect.value = settings.theme ?? 'system';
    themeSelect.addEventListener('change', () => {
      settings.theme = themeSelect.value; applyTheme(); render();
    });
    function saveSpreadFromSplit() {
      const v = getSplit('spread', 2); // örn 7.50
      if (!(v >= 0) || v > 50) { alert('Spread %0 - %50 arası olmalı'); setSplit('spread', (settings.spread ?? 0.07)*100, 2); return; }
      settings.spread = v / 100; render();
    }
    // kaydet spread değişince
    qs('#spreadInt').addEventListener('change', saveSpreadFromSplit);
    qs('#spreadFrac').addEventListener('change', saveSpreadFromSplit);

    // export/import/clear
    qs('#exportBtn').addEventListener('click', () => {
      const data = { transactions, prices, settings };
      const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'altintakip-backup.json'; a.click();
      URL.revokeObjectURL(url);
    });
    qs('#importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const txt = await file.text();
        const data = JSON.parse(txt);
        if (!data) throw new Error('Geçersiz dosya');
        if (Array.isArray(data.transactions)) transactions = data.transactions;
        if (Array.isArray(data.prices)) prices = data.prices;
        if (data.settings) settings = { ...settings, ...data.settings };
        applyTheme(); render(); alert('İçe aktarıldı');
      } catch (err) {
        alert('İçe aktarma hatası: '+err.message);
      } finally { e.target.value = ''; }
    });
    qs('#clearBtn').addEventListener('click', () => {
      if (!confirm('Tüm verileri silmek istediğine emin misin?')) return;
      transactions = []; prices = []; settings = { spread: 0.07, theme: 'system' };
      applyTheme(); render();
    });

    // footer year
    qs('#year').textContent = new Date().getFullYear();

    // first render
    render();

    // PWA SW
    if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>